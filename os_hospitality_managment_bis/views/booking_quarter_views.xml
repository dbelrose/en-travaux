<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================= -->
    <!-- VUES BOOKING.QUARTER -->
    <!-- ========================================= -->

    <!-- Vue formulaire booking.quarter -->
    <record id="view_booking_quarter_form" model="ir.ui.view">
        <field name="name">booking.quarter.form</field>
        <field name="model">booking.quarter</field>
        <field name="arch" type="xml">
            <form string="Déclaration trimestrielle de taxe de séjour">
                <header>
                    <button name="action_recalculate"
                            string="Recalculer"
                            type="object"
                            class="btn-secondary"/>
                    <button name="action_confirm"
                            string="Confirmer"
                            type="object"
                            class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_generate_tax_invoice"
                            string="Générer facture taxe"
                            type="object"
                            class="btn-primary"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,declared"/>
                </header>

                <sheet>
                    <div class="oe_title">
                        <h1><field name="display_name" readonly="1"/></h1>
                    </div>

                    <group>
                        <group string="Période">
                            <field name="year"/>
                            <field name="quarter"/>
                            <field name="property_type_id" options="{'no_create': True}"/>
                        </group>
                        <group string="Établissement">
                            <field name="establishment_name" readonly="1"/>
                            <field name="establishment_address" readonly="1"/>
                            <field name="establishment_capacity" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Détail par mois" name="monthly_detail">
                            <group>
                                <group string="Mois 1">
                                    <field name="nights_month1" readonly="1"/>
                                    <field name="exempt_nights_month1" readonly="1"/>
                                    <field name="taxable_nights_month1" readonly="1"/>
                                    <field name="tax_amount_month1" readonly="1" widget="monetary"/>
                                </group>
                                <group string="Mois 2">
                                    <field name="nights_month2" readonly="1"/>
                                    <field name="exempt_nights_month2" readonly="1"/>
                                    <field name="taxable_nights_month2" readonly="1"/>
                                    <field name="tax_amount_month2" readonly="1" widget="monetary"/>
                                </group>
                            </group>
                            <group>
                                <group string="Mois 3">
                                    <field name="nights_month3" readonly="1"/>
                                    <field name="exempt_nights_month3" readonly="1"/>
                                    <field name="taxable_nights_month3" readonly="1"/>
                                    <field name="tax_amount_month3" readonly="1" widget="monetary"/>
                                </group>
                                <group string="Total trimestre">
                                    <field name="total_nights" readonly="1"/>
                                    <field name="total_exempt_nights" readonly="1"/>
                                    <field name="total_taxable_nights" readonly="1"/>
                                    <field name="total_tax_amount" readonly="1" widget="monetary"/>
                                </group>
                            </group>
                            <group>
                                <field name="total_tax_words" readonly="1" colspan="2"/>
                            </group>
                        </page>

                        <page string="Facture" name="invoice" invisible="not tax_invoice_id">
                            <field name="tax_invoice_id" readonly="1"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ========================================= -->
    <!-- VUES BOOKING.QUARTER MISES À JOUR -->
    <!-- ========================================= -->

    <!-- Vue formulaire booking.quarter mise à jour -->
    <record id="view_booking_quarter_form_updated" model="ir.ui.view">
        <field name="name">booking.quarter.form.updated</field>
        <field name="model">booking.quarter</field>
        <field name="inherit_id" ref="view_booking_quarter_form"/>
        <field name="arch" type="xml">
            <!-- Ajout des informations sur le produit taxe de séjour -->
            <group string="Établissement" position="after">
                <group string="Configuration Taxe de séjour">
                    <field name="tourist_tax_product_id" readonly="1"/>
                    <field name="tourist_tax_unit_price" readonly="1" widget="monetary" string="Prix unitaire (XPF/nuitée)"/>
                </group>
            </group>

            <!-- Mise à jour du détail par mois avec produit -->
            <page string="Détail par mois" name="monthly_detail" position="attributes">
                <attribute name="string">Détail par mois (Taxe configurée)</attribute>
            </page>

            <!-- Ajout d'une note explicative -->
            <field name="total_tax_words" position="after">
                <separator string="Configuration"/>
                <p class="text-muted">
                    Le calcul de la taxe de séjour utilise le produit configuré ci-dessus.
                    Pour modifier le tarif, veuillez ajuster le prix du produit ou créer une règle
                    dans la liste de prix "Tarifs Municipalité".
                </p>
            </field>
        </field>
    </record>

    <!-- Vue liste booking.quarter -->
    <record id="view_booking_quarter_tree" model="ir.ui.view">
        <field name="name">booking.quarter.tree</field>
        <field name="model">booking.quarter</field>
        <field name="arch" type="xml">
            <tree string="Déclarations trimestrielles">
                <field name="display_name"/>
                <field name="year"/>
                <field name="quarter"/>
                <field name="property_type_id"/>
                <field name="total_taxable_nights"/>
                <field name="total_tax_amount" sum="Total taxes" widget="monetary"/>
                <field name="state" widget="badge"
                       decoration-info="state == 'draft'"
                       decoration-success="state == 'confirmed'"
                       decoration-warning="state == 'declared'"/>
                <field name="tax_invoice_id" optional="hide"/>
            </tree>
        </field>
    </record>

    <!-- Action booking.quarter -->
    <record id="action_booking_quarter" model="ir.actions.act_window">
        <field name="name">Déclarations trimestrielles</field>
        <field name="res_model">booking.quarter</field>
        <field name="view_mode">tree,form</field>
    </record>

</odoo>