<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Menu principal Booking -->
        <menuitem id="menu_hospitality_root"
                  name="Hospitality Management"
                  sequence="50"
                  web_icon="os_hospitality_managment,static/description/icon.png"/>

        <menuitem id="menu_import_root"
                  name="‚¨ÜÔ∏è R√©servations"
                  parent="menu_hospitality_root"
                  action="action_booking_import"
                  sequence="10"/>

        <menuitem id="menu_booking_import"
                  name="‚¨ÜÔ∏è Booking.com"
                  parent="menu_import_root"
                  action="action_booking_import"
                  sequence="10"/>

        <menuitem id="menu_booking_import_wizard"
                  name="Booking Import Wizard"
                  parent="menu_hospitality_root"
                  action="action_booking_import_wizard"
                  sequence="30"/>

        <menuitem id="menu_booking_import_line_wizard"
                  name="Booking Import Line Wizard"
                  parent="menu_hospitality_root"
                  action="action_booking_import_line_wizard"
                  sequence="40"/>

        <menuitem id="menu_booking_month"
                  name="Booking Month"
                  parent="menu_hospitality_root"
                  action="action_booking_month"
                  sequence="50"/>

        <menuitem id="menu_booking_quarter"
                  name="Booking Quarter"
                  parent="menu_hospitality_root"
                  action="action_booking_quarter"
                  sequence="60"/>

        <menuitem id="menu_booking_manual_wizard"
                  name="Booking Manual Wizard"
                  parent="menu_hospitality_root"
                  action="action_booking_manual_wizard"
                  sequence="60"/>

        <!-- ========================================= -->
        <!-- SOUS-MENU R√âSERVATIONS -->
        <!-- ========================================= -->
        <menuitem id="menu_hospitality_bookings"
                  name="üëÅÔ∏è R√©servations"
                  parent="menu_hospitality_root"
                  sequence="10"/>

       <!-- Vue unitaire -->
         <menuitem id="menu_booking_import_line"
                  name="üëÅÔ∏è Vue unitaire"
                  parent="menu_hospitality_bookings"
                  action="action_booking_import_line"
                  sequence="20"/>

       <!-- Vue mensuelle -->
        <menuitem id="menu_booking_month"
                  name="üëÅÔ∏è Vue mensuelle"
                  parent="menu_hospitality_bookings"
                  action="action_booking_month"
                  sequence="30"/>

        <!-- Vue trimestrielle -->
        <menuitem id="menu_booking_quarter"
                  name="üëÅÔ∏è Vue trimestrielle"
                  parent="menu_hospitality_bookings"
                  action="action_booking_quarter"
                  sequence="40"/>

        <!-- Vue annuelle -->
        <!-- todo: cr√©er l'action pour la vue annuelle -->
        <menuitem id="menu_booking_year"
                  name="üëÅÔ∏è Vue annuelle"
                  parent="menu_hospitality_bookings"
                  sequence="50"/>
<!--                  action="action_booking_year"-->

        <!-- ========================================= -->
        <!-- SOUS-MENU CONFIGURATION -->
        <!-- ========================================= -->
        <menuitem id="menu_hospitality_config"
                  name="Configuration"
                  parent="menu_hospitality_root"
                  sequence="90"/>

        <!-- Assistant de configuration -->
        <record id="action_hospitality_config_wizard" model="ir.actions.act_window">
            <field name="name">Assistant de configuration</field>
            <field name="res_model">hospitality.config.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="view_id" ref="view_hospitality_config_wizard_form"/>
        </record>

        <menuitem id="menu_hospitality_config_wizard"
                  name="‚öôÔ∏è Assistant de configuration"
                  parent="menu_hospitality_config"
                  action="action_hospitality_config_wizard"
                  sequence="10"/>

        <!-- Configuration des tarifs -->
        <menuitem id="menu_hospitality_rates_config"
                  name="Configuration des tarifs"
                  parent="menu_hospitality_config"
                  action="action_configure_hospitality_rates"
                  sequence="20"/>

        <!-- ========================================= -->
        <!-- SOUS-MENU PRODUITS ET SERVICES -->
        <!-- ========================================= -->
        <menuitem id="menu_hospitality_products"
                  name="Produits et Services"
                  parent="menu_hospitality_config"
                  sequence="30"/>

        <!-- Produits de service -->
        <menuitem id="menu_hospitality_service_products"
                  name="Services Hospitality"
                  parent="menu_hospitality_products"
                  action="action_hospitality_service_products"
                  sequence="10"/>

        <!-- Listes de prix -->
        <menuitem id="menu_hospitality_pricelists"
                  name="Listes de prix"
                  parent="menu_hospitality_products"
                  action="action_hospitality_pricelists"
                  sequence="20"/>

        <!-- ========================================= -->
        <!-- ACTIONS RAPIDES -->
        <!-- ========================================= -->

        <!-- Action pour cr√©er un nouveau produit de service -->
        <record id="action_create_service_product" model="ir.actions.act_window">
            <field name="name">Nouveau produit de service</field>
            <field name="res_model">product.template</field>
            <field name="view_mode">form</field>
            <field name="target">current</field>
            <field name="context">{
                'default_type': 'service',
                'default_purchase_ok': True,
                'default_sale_ok': False,
                'default_categ_id': %(product_category_commissions)d
            }</field>
    <!--            'default_can_be_expensed': True,-->
            <field name="view_id" ref="view_hospitality_service_products_form"/>
        </record>

        <menuitem id="menu_create_service_product"
                  name="‚ûï Nouveau service"
                  parent="menu_hospitality_products"
                  action="action_create_service_product"
                  sequence="30"/>

        <!-- ========================================= -->
        <!-- TABLEAU DE BORD -->
        <!-- ========================================= -->

        <!-- Action pour le tableau de bord -->
        <record id="action_hospitality_dashboard" model="ir.actions.act_window">
            <field name="name">Tableau de bord Hospitality</field>
            <field name="res_model">booking.month</field>
            <field name="view_mode">kanban,tree,graph</field>
            <field name="domain">[
                ('year', '=', datetime.datetime.now().year),
                ('month', '>=', datetime.datetime.now().month - 2)
            ]</field>
            <field name="context">{
                'group_by': 'month'
            }</field>
        </record>

        <menuitem id="menu_hospitality_dashboard"
                  name="üìä Tableau de bord"
                  parent="menu_hospitality_root"
                  action="action_hospitality_dashboard"
                  sequence="5"/>

        <!-- ========================================= -->
        <!-- RAPPORTS -->
        <!-- ========================================= -->

        <menuitem id="menu_hospitality_reports"
                  name="Rapports"
                  parent="menu_hospitality_root"
                  sequence="80"/>

        <!-- Rapport mensuel -->
        <record id="action_monthly_report" model="ir.actions.act_window">
            <field name="name">Rapport mensuel</field>
            <field name="res_model">booking.month</field>
            <field name="view_mode">pivot,graph,tree</field>
            <field name="context">{
                'group_by': ['year', 'month']
            }</field>
        </record>

        <menuitem id="menu_monthly_report"
                  name="Rapport mensuel"
                  parent="menu_hospitality_reports"
                  action="action_monthly_report"
                  sequence="10"/>

        <!-- Rapport trimestriel -->
        <record id="action_quarterly_report" model="ir.actions.act_window">
            <field name="name">Rapport trimestriel</field>
            <field name="res_model">booking.quarter</field>
            <field name="view_mode">pivot,graph,tree</field>
            <field name="context">{
                'group_by': ['year', 'quarter', 'property_type_id']
            }</field>
        </record>

        <menuitem id="menu_quarterly_report"
                  name="Rapport trimestriel"
                  parent="menu_hospitality_reports"
                  action="action_quarterly_report"
                  sequence="20"/>

        <!-- ========================================= -->
        <!-- PARAM√àTRES AVANC√âS -->
        <!-- ========================================= -->

        <menuitem id="menu_hospitality_advanced"
                  name="Param√®tres avanc√©s"
                  parent="menu_hospitality_config"
                  sequence="90"
                  groups="base.group_system"/>

        <!-- Comptes comptables -->
        <record id="action_hospitality_accounts" model="ir.actions.act_window">
            <field name="name">Comptes comptables Hospitality</field>
            <field name="res_model">account.account</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[
                ('code', 'in', ['62220000', '63513000'])
            ]</field>
        </record>

        <menuitem id="menu_hospitality_accounts"
                  name="Comptes comptables"
                  parent="menu_hospitality_advanced"
                  action="action_hospitality_accounts"
                  sequence="10"/>

        <!-- Partenaires Hospitality -->
        <record id="action_hospitality_partners" model="ir.actions.act_window">
            <field name="name">Partenaires Hospitality</field>
            <field name="res_model">res.partner</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[
                ('name', 'in', ['Mairie de Punaauia', 'Booking.com'])
            ]</field>
        </record>

        <menuitem id="menu_hospitality_partners"
                  name="Partenaires"
                  parent="menu_hospitality_advanced"
                  action="action_hospitality_partners"
                  sequence="20"/>

        <!-- ========================================= -->
        <!-- ACTIONS CONTEXTUELLES -->
        <!-- ========================================= -->

        <!-- Action pour recalculer toutes les vues mensuelles -->
        <record id="action_recalculate_all_months" model="ir.actions.server">
            <field name="name">Recalculer toutes les vues mensuelles</field>
            <field name="model_id" ref="model_booking_month"/>
            <field name="binding_model_id" ref="model_booking_month"/>
            <field name="binding_view_types">list</field>
            <field name="state">code</field>
            <field name="code">
    for record in records:
        record.action_recalculate()
            </field>
        </record>

        <!-- Action pour recalculer toutes les d√©clarations trimestrielles -->
        <record id="action_recalculate_all_quarters" model="ir.actions.server">
            <field name="name">Recalculer toutes les d√©clarations</field>
            <field name="model_id" ref="model_booking_quarter"/>
            <field name="binding_model_id" ref="model_booking_quarter"/>
            <field name="binding_view_types">list</field>
            <field name="state">code</field>
            <field name="code">
    for record in records:
        record.action_recalculate()
            </field>
        </record>

        <!-- Action pour g√©n√©rer toutes les factures manquantes -->
        <record id="action_generate_missing_invoices" model="ir.actions.server">
            <field name="name">G√©n√©rer factures manquantes</field>
            <field name="model_id" ref="model_booking_month"/>
            <field name="binding_model_id" ref="model_booking_month"/>
            <field name="binding_view_types">list</field>
            <field name="state">code</field>
            <field name="code">
count = 0
error_count = 0
for record in records:
    if record.invoice_state != 'all':
        try:
            record.action_generate_all_invoices()
            count += 1
        except Exception as e:
            error_count += 1
            pass

message = f'{count} factures g√©n√©r√©es'

action = {
    'type': 'ir.actions.client',
    'tag': 'display_notification',
    'params': {
        'title': 'G√©n√©ration des factures manquantes',
        'message': message,
        'type': 'success' if error_count == 0 else 'warning',
        'sticky': False,
    }
}
            </field>
        </record>

        <!-- ========================================= -->
        <!-- VUES GRAPHIQUES -->
        <!-- ========================================= -->

        <!-- Vue graphique pour les revenus mensuels -->
        <record id="view_booking_month_graph" model="ir.ui.view">
            <field name="name">booking.month.graph</field>
            <field name="model">booking.month</field>
            <field name="arch" type="xml">
                <graph string="Revenus mensuels" type="line">
                    <field name="month" type="row"/>
                    <field name="total_revenue" type="measure"/>
                    <field name="net_revenue" type="measure"/>
                    <field name="concierge_commission" type="measure"/>
                    <field name="total_commission_booking" type="measure"/>
                </graph>
            </field>
        </record>

        <!-- Vue pivot pour les revenus mensuels -->
        <record id="view_booking_month_pivot" model="ir.ui.view">
            <field name="name">booking.month.pivot</field>
            <field name="model">booking.month</field>
            <field name="arch" type="xml">
                <pivot string="Analyse des revenus">
                    <field name="year" type="col"/>
                    <field name="total_revenue" type="measure"/>
                    <field name="net_revenue" type="measure"/>
                    <field name="total_reservations" type="measure"/>
                </pivot>
            </field>
        </record>

        <!-- Vue graphique pour les taxes trimestrielles -->
        <record id="view_booking_quarter_graph" model="ir.ui.view">
            <field name="name">booking.quarter.graph</field>
            <field name="model">booking.quarter</field>
            <field name="arch" type="xml">
                <graph string="Taxes de s√©jour trimestrielles" type="bar">
                    <field name="quarter" type="row"/>
                    <field name="total_taxable_nights" type="measure"/>
                    <field name="total_tax_amount" type="measure"/>
                </graph>
            </field>
        </record>

        <!-- ========================================= -->
        <!-- MISE √Ä JOUR DES ACTIONS EXISTANTES -->
        <!-- ========================================= -->

        <!-- Mise √† jour de l'action booking_month pour inclure les nouvelles vues -->
        <record id="action_booking_month" model="ir.actions.act_window">
            <field name="view_mode">tree,form,kanban,graph,pivot</field>
        </record>

        <!-- Mise √† jour de l'action booking_quarter pour inclure les nouvelles vues -->
        <record id="action_booking_quarter" model="ir.actions.act_window">
            <field name="view_mode">tree,form,graph</field>
        </record>

        <!-- Action serveur : G√©n√©rer toutes les factures du mois -->
        <record id="action_server_generate_all_invoices" model="ir.actions.server">
            <field name="name">G√©n√©rer toutes les factures</field>
            <field name="model_id" ref="model_booking_month"/>
            <field name="binding_model_id" ref="model_booking_month"/>
            <field name="binding_view_types">list,form</field>
            <field name="state">code</field>
            <field name="code">
if records:
    action = records[0].action_generate_all_invoices()
            </field>
        </record>

        <!-- Action serveur : G√©n√©rer uniquement la facture Booking.com globale -->
        <record id="action_server_generate_booking_invoice" model="ir.actions.server">
            <field name="name">G√©n√©rer facture Booking.com</field>
            <field name="model_id" ref="model_booking_month"/>
            <field name="binding_model_id" ref="model_booking_month"/>
            <field name="binding_view_types">list,form</field>
            <field name="state">code</field>
            <field name="code">
if records:
    # Peu importe le nombre d'enregistrements s√©lectionn√©s, on g√©n√®re UNE facture globale
    # On utilise le premier enregistrement comme point de d√©part
    try:
        num = records[0].action_generate_booking_invoice()
        if num > 0:
            raise UserError(f"Facture Booking.com globale cr√©√©e pour {records[0].month:02d}/{records[0].year} !")
        else:
            raise UserError("Aucune r√©servation √† facturer pour Booking.com.")
    except ValueError as e:
        raise UserError(str(e))
            </field>
        </record>

        <!-- Action serveur : G√©n√©rer les factures concierge (par propri√©t√©) -->
        <record id="action_server_generate_concierge_invoices" model="ir.actions.server">
            <field name="name">G√©n√©rer factures concierge</field>
            <field name="model_id" ref="model_booking_month"/>
            <field name="binding_model_id" ref="model_booking_month"/>
            <field name="binding_view_types">list,form</field>
            <field name="state">code</field>
            <field name="code">
if records:
    for record in records:
        if record.concierge_commission > 0:
            record.action_generate_both_concierge_invoices()
            </field>
        </record>
    </data>
</odoo>