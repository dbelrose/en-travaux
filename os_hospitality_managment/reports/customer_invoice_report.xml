<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template de facture personnalisé pour l'hospitalité -->
    <record id="hospitality_invoice_document" model="ir.ui.view">
        <field name="name">Hospitality Invoice Document</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.report_invoice_document"/>
        <field name="arch" type="xml">
            <!-- Ajout d'informations spécifiques à l'hospitalité -->
            <xpath expr="//div[@name='invoice_date']" position="after">
                <div t-if="o.booking_month_id" class="col-auto col-3 mw-100 mb-2">
                    <strong>Période séjour:</strong>
                    <p class="m-0" t-field="o.booking_month_id.display_name"/>
                </div>
            </xpath>

            <!-- Personnalisation des lignes de facture -->
            <xpath expr="//table[@name='invoice_line_table']//tbody//td[1]" position="attributes">
                <attribute name="class">text-left</attribute>
            </xpath>
            
            <!-- Ajout d'un footer spécifique -->
            <xpath expr="//div[@id='total']" position="after">
                <div t-if="o.booking_month_id" class="row mt-4">
                    <div class="col-12">
                        <hr/>
                        <p class="text-muted">
                            <small>
                                Cette facture concerne les services d'hébergement touristique 
                                pour la période <span t-field="o.booking_month_id.display_name"/>.
                                <br/>
                                La taxe de séjour, si applicable, est reversée à la municipalité 
                                conformément à la réglementation en vigueur.
                            </small>
                        </p>
                    </div>
                </div>
            </xpath>
        </field>
    </record>

    <!-- Rapport spécifique pour les factures d'hospitalité -->
    <record id="action_report_hospitality_invoice" model="ir.actions.report">
        <field name="name">Facture Hospitalité</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">os_hospitality_managment.hospitality_invoice_template</field>
        <field name="report_file">os_hospitality_managment.hospitality_invoice_template</field>
        <field name="print_report_name">'Facture - %s' % (object.name)</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
    </record>

    <!-- Template principal du rapport -->
    <template id="hospitality_invoice_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-set="lang" t-value="o.invoice_user_id.lang if o.move_type in ('in_invoice', 'in_refund') else o.partner_id.lang"/>
                <t t-call="os_hospitality_managment.hospitality_invoice_document" t-lang="lang"/>
            </t>
        </t>
    </template>

    <!-- Document de facture personnalisé -->
    <template id="hospitality_invoice_document" inherit_id="account.report_invoice_document">
        <!-- En-tête personnalisé -->
        <xpath expr="//h2" position="replace">
            <h2>
                <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">Facture</span>
                <span t-elif="o.move_type == 'out_invoice' and o.state == 'draft'">Facture Brouillon</span>
                <span t-elif="o.move_type == 'out_refund'">Avoir</span>
                <span t-elif="o.move_type == 'in_refund'">Avoir fournisseur</span>
                <span t-elif="o.move_type == 'in_invoice'">Facture fournisseur</span>
                <span t-field="o.name"/>
                
                <!-- Badge pour les factures d'hospitalité -->
                <small t-if="o.booking_month_id" class="badge badge-info ml-2">Hospitalité</small>
            </h2>
        </xpath>

        <!-- Informations sur le séjour -->
        <xpath expr="//div[@name='invoice_date']" position="after">
            <div t-if="o.booking_month_id" class="col-auto col-3 mw-100 mb-2">
                <strong>Mois de séjour:</strong>
                <p class="m-0" t-field="o.booking_month_id.display_name"/>
            </div>
            
            <div t-if="o.booking_month_id" class="col-auto col-3 mw-100 mb-2">
                <strong>Type hébergement:</strong>
                <p class="m-0" t-field="o.booking_month_id.property_type_id.name"/>
            </div>
        </xpath>

        <!-- Personnalisation du tableau des lignes -->
        <xpath expr="//th[@name='th_description']" position="replace">
            <th name="th_description" class="text-left">
                <span>Description du séjour</span>
            </th>
        </xpath>

        <!-- Footer informatif -->
        <xpath expr="//div[@name='comment']" position="before">
            <div t-if="o.booking_month_id" class="row">
                <div class="col-12">
                    <div class="alert alert-info">
                        <h6><i class="fa fa-info-circle"/> Informations sur votre séjour</h6>
                        <p class="mb-1">
                            <strong>Période:</strong> <span t-field="o.booking_month_id.period_start"/> au <span t-field="o.booking_month_id.period_end"/>
                        </p>
                        <p class="mb-1">
                            <strong>Hébergement:</strong> <span t-field="o.booking_month_id.property_type_id.name"/>
                        </p>
                        <p class="mb-0">
                            Les taxes de séjour incluses dans cette facture sont reversées à la municipalité 
                            conformément à la réglementation locale.
                        </p>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <!-- Style CSS personnalisé pour les factures -->
    <template id="hospitality_invoice_style">
<!--    <template id="hospitality_invoice_style" inherit_id="web.report_assets_common">-->
        <xpath expr="." position="inside">
            <style>
                .hospitality-invoice .badge-info {
                    background-color: #17a2b8;
                    color: white;
                    font-size: 0.75em;
                    padding: 0.25em 0.5em;
                    border-radius: 0.25rem;
                }
                
                .hospitality-invoice .alert-info {
                    background-color: #e1f5fe;
                    border: 1px solid #81d4fa;
                    color: #0277bd;
                    border-radius: 0.25rem;
                    padding: 1rem;
                    margin: 1rem 0;
                }
                
                .hospitality-invoice .alert-info h6 {
                    color: #01579b;
                    margin-bottom: 0.5rem;
                }
            </style>
        </xpath>
    </template>

</odoo>